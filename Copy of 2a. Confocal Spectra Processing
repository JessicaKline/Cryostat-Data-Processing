{"cells":[{"cell_type":"code","source":["## Processing single QD spectra\n","## convert from nm -> eV and fit to a single gaussian\n","## returns FWHM, Em. Max, amplitude and gaussian"],"metadata":{"id":"ybGqVIwAcMY-"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["#### Mount Sharepoint #####\n","\n","!wget https://downloads.rclone.org/v1.61.1/rclone-v1.61.1-linux-amd64.deb\n","!apt install ./rclone-v1.61.1-linux-amd64.deb\n","\n","!rclone config\n","\n","!sudo mkdir /content/sharepoint\n","!nohup rclone --vfs-cache-mode writes mount sharepoint: /content/sharepoint &\n","\n","#### Mount Sharepoint #####"],"metadata":{"id":"_MEfvP55tFmE","collapsed":true},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["#@title imports\n","#### Common Imports #####\n","\n","import matplotlib.pyplot as plt\n","import numpy as np\n","import pandas as pd\n","from matplotlib.ticker import MultipleLocator\n","import math\n","import os\n","from os import listdir\n","from os.path import isfile, join\n","import logging\n","from scipy import optimize\n","import seaborn as sns\n","\n","#### Common Imports #####\n","\n","#### RC Params #####\n","\n","plt.rcParams['savefig.dpi'] = 300\n","plt.rcParams['font.size'] = 22\n","plt.rcParams['font.family'] = 'sans-serif'\n","plt.rcParams['font.sans-serif'] = 'Arial'\n","plt.rcParams['xtick.major.pad']='10'\n","plt.rcParams['ytick.major.pad']='4'\n","\n","logging.getLogger('matplotlib.font_manager').disabled = True\n","\n","#### RC Params #####\n"],"metadata":{"cellView":"form","id":"vJBJ6EQftMYy"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["#@title helper functions\n","\n","#### Common Helper Functions #####\n","\n","def read_csv(file_path):\n","  g2 = pd.read_csv(file_path)\n","  g2 = g2.to_numpy()\n","  return g2\n","\n","def save_fig(filename):\n","  plt.savefig(filename, bbox_inches = 'tight')\n","\n","def set_figsize(width_, height_):\n","  ff = plt.gcf()\n","  ff.set_figwidth(width_)\n","  ff.set_figheight(height_)\n","  ff.tight_layout()\n","\n","def tick_settings(x_minor = 1, y_minor = 1):\n","  plt.gca().xaxis.set_minor_locator(MultipleLocator(x_minor))\n","  plt.gca().yaxis.set_minor_locator(MultipleLocator(y_minor))\n","  plt.gca().tick_params(which='minor', bottom=True, top=True, left=True, right=True)\n","  plt.gca().tick_params(bottom=True, top=True, left=True, right=True)\n","  plt.tick_params(axis = 'both', direction = 'in', length = 6, width = 1.5)\n","  plt.gca().tick_params(which='minor', direction = \"in\", length = 4, width = 0.75)\n","\n","  for axis in ['top','bottom','left','right']:\n","    plt.gca().spines[axis].set_linewidth(1.5)\n","\n","def plot_settings(y_lim, x_lim, y_min, x_min, x_label, y_label):\n","  plt.gca().set_ylim(y_lim)\n","  plt.gca().set_xlim(x_lim)\n","  tick_settings(y_minor = y_min, x_minor = x_min)\n","\n","  plt.gca().set_xlabel(x_label, fontweight = 'bold')\n","  plt.gca().set_ylabel(y_label, fontweight = 'bold')\n","\n","def save_csv_report(fits, col_lst ,filename):\n","  fits = pd.DataFrame(fits.T)\n","  fits.columns = col_lst\n","  fits.to_csv(filename)\n","\n","def find_nearest(array, value):\n","    array = np.asarray(array)\n","    idx = (np.abs(array - value)).argmin()\n","    return idx\n","\n","def get_onlyfile(folder):\n","  return [f for f in listdir(folder) if isfile(join(folder, f))]\n","\n","#### Common Helper Functions #####\n","\n","def jacobian_transform(x_w, I_w):\n","  hc = 1239.8\n","\n","  x_E_ev = hc/x_w\n","  x_frequency = 3E8/(x_w*1E-9)\n","  I_E = I_w/(x_E_ev**2)\n","  I_E = I_E/(x_frequency**3)\n","  #I_E = I_E/np.sum(I_E)\n","  #I_E = I_E / np.amax(I_E)\n","\n","  return np.array([x_E_ev, I_E]).T\n","\n","def gaussian(x, amplitude1, mean1, stddev1):\n","    return amplitude1/(stddev1*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean1) /(stddev1))**2)\n","\n","def gaussian_b(x, amplitude1, mean1, stddev1, b):\n","    return amplitude1/(stddev1*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean1) /(stddev1))**2) + b\n","\n","def gaussian2(x, amplitude1, mean1, stddev1, amplitude2, mean2, stddev2):\n","    return amplitude1/(stddev1*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean1) /(stddev1))**2) + amplitude2/(stddev2*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean2) /(stddev2))**2)\n","\n","def gaussian3(x, amplitude1, mean1, stddev1, amplitude2, mean2, stddev2, amplitude3, mean3, stddev3):\n","    return amplitude1/(stddev1*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean1) /(stddev1))**2) + amplitude2/(stddev2*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean2) /(stddev2))**2) + amplitude3/(stddev3*np.sqrt(2*3.14)) * np.exp(-0.5*((x - mean3) /(stddev3))**2)"],"metadata":{"id":"LLI7xFaAtS5J","cellView":"form"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["#@title single spectrum\n","## fit to a gaussian and save data parameters\n","\n","folder_string = 'insert file path here'   ## file path to overarching folder X which contains X/QD{n}/Spectra\n","\n","background_file = 'insert file path here'     ##background spectrum\n","\n","common_tag = 'insert tag here'            ## common save tag to data (often contains measurement parameters, ie '_472nm_15MHz_20s')\n","\n","fwhm = []\n","em_max = []\n","\n","for qd_num in range(0,200):\n","  # if qd_num != 9 and qd_num != 11:\n","  checkpath = folder_string+f'/QD{qd_num}/'\n","  pl_spectra = folder_string+f'/QD{qd_num}/Spectra/QD{qd_num}'+common_tag+'.csv'\n","\n","  save_location = folder_string+f'/QD{qd_num}/Spectra/QD{qd_num}.png'\n","  save_location2 = folder_string+f'/QD{qd_num}/Spectra/fit_paras.csv'\n","  save_location3 = folder_string+f'/QD{qd_num}/Spectra/spectrum_fits.csv'\n","\n","  fit_to_peaks = 1\n","\n","  if os.path.exists(checkpath) == True:\n","    data = process_PL_slice(background_file, pl_spectra)\n","    data[:,1] /= np.nanmax(data[:,1])\n","\n","    loc = np.argmax(data[:,1])\n","    shift = find_nearest(data[loc:,1], 0.6)\n","    loc += shift\n","    popt, _ = optimize.curve_fit(gaussian_b, data[:loc,0], data[:loc,1], p0 = [1, 2.4, 0.01, 0.01], bounds = ([0,2.3,0, 0], [10, 2.6, 0.2, 0.3]), nan_policy='omit')\n","\n","\n","    fit = gaussian_b(data[:,0], popt[0], popt[1], popt[2], popt[3])\n","    width = 1000*2.355*popt[2]\n","    plt.text(2.45, 0.9, 'Em. Max: ' + str(popt[1])[:5] + ' eV\\nFWMH: ' + str(width)[:5] + ' meV', verticalalignment = 'top', horizontalalignment = 'left', fontsize = 14)\n","\n","    plt.plot(data[:,0], data[:,1], color = 'k', linewidth = 3)\n","    plt.plot(data[:,0], fit, color = 'r', linewidth = 2)\n","\n","    fwhm.append(width)\n","    em_max.append(popt[1])\n","\n","\n","    fits =np.array([[popt[0]], [popt[1]], [popt[2]], [popt[3]]])\n","\n","    save_csv_report(fits, ['A', 'Em Max (eV)', 'Std (eV)', 'B'] , save_location2)\n","    save_csv_report(np.array([data[:,0], data[:,1], fit]), ['energy (ev)', 'data', 'fit'], save_location3)\n","\n","    plot_settings(y_lim = [-0.1,1], x_lim = [np.amin(data[:,0]), np.amax(data[:,0])], y_min = 0.1, x_min = 0.1, x_label = 'Energy (eV)', y_label = 'Intensity')\n","\n","    save_fig(save_location)\n","    plt.close()\n","  else:\n","    print(f'except-{qd_num}')\n"],"metadata":{"id":"hi_bIbiBtYZZ"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["#@title check fits\n","##plot all QD spectra for visual check on good fits and good spectra\n","import matplotlib.image as mpimg\n","import time\n","\n","directory = 'insert file path here'       ## file path to overarching folder X which contains X/QD{n}/Spectra\n","\n","plt.ion()\n","\n","for qd_num in range(1,200):\n","  qd_num_path = directory + f'QD{qd_num}/'\n","  if os.path.exists(qd_num_path) == True:\n","    # apd_loc_path = qd_num_path + 'APD/Analyzed Data/'\n","    spectra_loc_path = qd_num_path + 'Spectra/'\n","\n","    print(qd_num)\n","    img = mpimg.imread(spectra_loc_path+f'QD{qd_num}.png')\n","\n","    plt.imshow(img)\n","    plt.axis('off')\n","    set_figsize(width_ = 6, height_ =6)\n","\n","    plt.show()\n","\n","    time.sleep(1)\n","    keep_trace = input('Move to next (any key)')\n","    plt.close()"],"metadata":{"id":"oo89yEb6y0js"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[],"authorship_tag":"ABX9TyM/EL2folZ7tOjWi6q6jWsT"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}